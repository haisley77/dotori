pipeline {
    agent any

    environment {
        imageName = "haisley77/dotori-backend"
        registryCredential = 'dockerhub_token'

        releaseServerAccount = 'ubuntu'
        releaseServerUri = 'dotori.online'
        releasePort = '8081'
    }

    stages {
        stage('Git Clone') {
            steps {
                echo 'Cloning repository...'
                git branch: 'develop-be',
                    credentialsId: 'github_token',
                    url: 'https://github.com/haisley77/dotori.git'
            }
        }
        stage('Jar Build') {
            steps {
                dir ('backend') {
                    echo 'Building Jar file...'
                    sh 'chmod +x ./gradlew'
                    sh './gradlew clean bootJar'
                }
            }
        }
        stage('Image Build & DockerHub Push') {
            steps {
                dir('backend') {
                    script {
                        docker.withRegistry('', registryCredential) {
                           sh "docker build -t $imageName:$BUILD_NUMBER ."
                           sh "docker build -t $imageName:latest ."

                           sh "docker push $imageName:$BUILD_NUMBER"
                           sh "docker push $imageName:latest"
                        }
                    }
                }
            }
        }

        stage('DockerHub Pull') {
            steps {
                sshagent(credentials: ['aws_key']) {
                    sh "ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri 'sudo docker pull $imageName:latest'"
                }
            }
        }
        stage('Before Service Stop') {
            steps {
                sshagent(credentials: ['aws_key']) {
                    sh '''
                    if test "`ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker ps -aq --filter ancestor=$imageName:latest"`"; then
                    ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker stop $(docker ps -aq --filter ancestor=$imageName:latest)"
                    ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker rm -f $(docker ps -aq --filter ancestor=$imageName:latest)"
                    ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker rmi $imageName:latest"
                    fi
                    '''
                }
            }
        }
        stage('Service Start') {
            steps {
                sshagent(credentials: ['aws_key']) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "sudo docker run -i -e TZ=Asia/Seoul -e "SPRING_PROFILES_ACTIVE=prod" --name codespeed -p $releasePort:$releasePort -d $imageName:latest"
                    '''
                }
            }
        }
    }
    post {
        success {
            echo 'Deployment successful!'
        }
        failure {
            echo 'Deployment failed.'
        }
    }
}